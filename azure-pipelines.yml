stages:
- stage: publish
  jobs:
  ############################
  # Publish job
  ############################
  - job: publish
    displayName: 'Publish artifacts'
    steps:
    - task: PublishPipelineArtifact@0
      inputs:
        artifactName: a1
        targetPath: files/a1
      displayName: Publish pipeline artifact (a1)

    - task: PublishPipelineArtifact@0
      inputs:
        artifactName: a2
        targetPath: files/a2
      displayName: Publish pipeline artifact (a2)

    - task: PublishPipelineArtifact@0
      inputs:
        artifactName: a3
        targetPath: files/a3
      displayName: Publish pipeline artifact (a3)

    - task: PublishBuildArtifacts@1
      inputs:
        pathtoPublish: '$(Build.SourcesDirectory)/files/a1'
        ArtifactName: b1
      displayName: Publish build artifacts (b1)

    - task: PublishBuildArtifacts@1
      inputs:
        pathtoPublish: '$(Build.SourcesDirectory)/files/a2'
        ArtifactName: b2
      displayName: Publish build artifacts (b2)

- stage: download
  dependsOn: publish
  jobs:
  ############################
  # Download jobs
  ############################
  - template: download-job.yml
    parameters:
      id: test1
      description: 'artifact=b1, itemPattern=**'
      artifactName: b1
      itemPattern: '**'

  - template: download-job.yml
    parameters:
      id: test2
      description: 'artifact=b1, itemPattern=b1/**'
      artifactName: b1
      itemPattern: 'b1/**'

  - template: download-job.yml
    parameters:
      id: test3
      description: 'artifact=b1, itemPattern=b2/**'
      artifactName: b1
      itemPattern: 'b2/**'

  - template: download-job.yml
    parameters:
      id: test4
      description: 'artifact=, itemPattern=b1/** (should fail since artifact is required)'
      itemPattern: 'b1/**'

  - template: download-job.yml
    parameters:
      id: test5
      description: 'artifact=b1, itemPattern=b1/*'
      artifactName: b1
      itemPattern: 'b1/*'

  - template: download-job.yml
    parameters:
      id: test6
      description: 'artifact=b1, itemPattern=b1/*.dll'
      artifactName: b1
      itemPattern: 'b1/*.dll'